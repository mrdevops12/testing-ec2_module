#!/bin/bash
set -euxo pipefail

# ===========================================================
#  JMeter Master/Slave Launcher (S3 + EFS Integrated)
# ===========================================================
#  - Mounts S3 using `mount -s3`
#  - Keeps plugin and use-case logic as-is
#  - Mounts EFS for result storage
#  - Repairs broken .jtl by fixing closing tag
#  - Adds CSV headers for JMeter HTML report generation
#  - Uploads results + status.txt to S3
# ===========================================================

# -----------------------------
# Input arguments (keep same order)
# -----------------------------
USECASE_NAME=$1
DATE_STAMP=$2
SLAVE_IPS=$3
CUSTOM_PROPS=""
CUSTOM_PROPS2=""

# -----------------------------
# Static configurations
# -----------------------------
EFS_ID="fs-068c1bab8aa9f3c9b"
REGION="us-east-1"
EFS_MOUNT="/mnt/efs-jmeter"
S3_BUCKET="dgx-dsope-jmeter-usecases-dev-s3"

JMETER_HOME="/opt/apache-jmeter-5.6.3"
JMETER_BIN="${JMETER_HOME}/bin"
JMETER_EXT="${JMETER_HOME}/lib/ext"

export JVM_ARGS="-Xms1024m -Xmx2867m"

# ===========================================================
# [STEP 1] Mount S3 using your existing approach
# ===========================================================
echo "[STEP 1] Mounting S3..."
sudo mkdir -p /mnt/jmeter
if ! mount | grep -q "/mnt/jmeter"; then
  echo "[INFO] Mounting S3 via mount -s3..."
  sudo mount -s3 "${S3_BUCKET}" /mnt/jmeter
else
  echo "[INFO] S3 already mounted."
fi

# ===========================================================
# [STEP 2] Mount EFS for result storage
# ===========================================================
echo "[STEP 2] Mounting EFS..."
sudo yum install -y amazon-efs-utils nfs-utils >/dev/null 2>&1 || true
sudo mkdir -p "${EFS_MOUNT}"

if ! mount | grep -q "${EFS_MOUNT}"; then
  if ! sudo mount -t efs "${EFS_ID}:/" "${EFS_MOUNT}" 2>/dev/null; then
    echo "[WARN] EFS native mount failed â€” retrying with NFS"
    sudo mount -t nfs4 -o nfsvers=4.1 "${EFS_ID}.efs.${REGION}.amazonaws.com:/" "${EFS_MOUNT}"
  fi
else
  echo "[INFO] EFS already mounted."
fi

# ===========================================================
# [STEP 3] Copy JMeter plugins from S3
# ===========================================================
if [ -d /mnt/jmeter/jmeter/plugins ]; then
  echo "[STEP 3] Copying JMeter plugins from S3..."
  sudo cp -u /mnt/jmeter/jmeter/plugins/*.jar "${JMETER_EXT}" || true
else
  echo "[WARN] No plugins found in S3 bucket."
fi

# ===========================================================
# [STEP 4] Ensure CSV header for valid report generation
# ===========================================================
echo "[STEP 4] Configuring JMeter for proper report generation..."
sudo sed -i '/jmeter.save.saveservice.output_format/d' "${JMETER_BIN}/jmeter.properties" || true
sudo sed -i '/jmeter.save.saveservice.print_field_names/d' "${JMETER_BIN}/jmeter.properties" || true
echo "jmeter.save.saveservice.output_format=csv" | sudo tee -a "${JMETER_BIN}/jmeter.properties" >/dev/null
echo "jmeter.save.saveservice.print_field_names=true" | sudo tee -a "${JMETER_BIN}/jmeter.properties" >/dev/null

# ===========================================================
# [STEP 5] Handle custom.properties if available
# ===========================================================
sudo rm -f /mnt/custom.properties || true

if [[ -f "/mnt/jmeter/use-cases/${USECASE_NAME}/custom.properties" ]]; then
  echo "[STEP 5] Found custom.properties for ${USECASE_NAME}, preparing..."
  while IFS= read -r line; do
    [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
    echo "$line" >> /mnt/custom.properties
  done < "/mnt/jmeter/use-cases/${USECASE_NAME}/custom.properties"

  for e_prop in $(cat /mnt/custom.properties); do
    CUSTOM_PROPS+=" -G${e_prop}"
    CUSTOM_PROPS2+=" -J${e_prop}"
  done
else
  echo "[INFO] No custom.properties found."
fi

CUSTOM_PROPS="${CUSTOM_PROPS} ${CUSTOM_PROPS2}"

# ===========================================================
# [STEP 6] Prepare EFS result directories
# ===========================================================
RESULT_DIR="${EFS_MOUNT}/results/${USECASE_NAME}/${DATE_STAMP}"
HTML_DIR="${RESULT_DIR}/HtmlReport"
sudo mkdir -p "${RESULT_DIR}" "${HTML_DIR}"

JTL_FILE="${RESULT_DIR}/${USECASE_NAME}.jtl"
LOG_FILE="${RESULT_DIR}/${USECASE_NAME}.log"
STATUS_FILE="${RESULT_DIR}/status.txt"

# ===========================================================
# [STEP 7] Build and execute JMeter command
# ===========================================================
echo "[STEP 7] Running JMeter test at $(date)"
cd "${JMETER_BIN}"

if [[ -z "$SLAVE_IPS" ]]; then
  sudo sh jmeter -n \
    -t "/mnt/jmeter/use-cases/${USECASE_NAME}/master.jmx" \
    -l "${JTL_FILE}" \
    -j "${LOG_FILE}" \
    -Jdatadir="/mnt/jmeter/use-cases/${USECASE_NAME}/data" \
    ${CUSTOM_PROPS} \
    -Jprometheus.port=9270 \
    -Jprometheus.host=0.0.0.0 \
    -GDateTime=${DATE_STAMP} -JDateTime=${DATE_STAMP} \
    -e -o "${HTML_DIR}"
else
  sudo sh jmeter -n \
    -t "/mnt/jmeter/use-cases/${USECASE_NAME}/master.jmx" -R "${SLAVE_IPS}" \
    -l "${JTL_FILE}" \
    -j "${LOG_FILE}" \
    -Jdatadir="/mnt/jmeter/use-cases/${USECASE_NAME}/data" \
    ${CUSTOM_PROPS} \
    -Jprometheus.port=9270 \
    -Jprometheus.host=0.0.0.0 \
    -GDateTime=${DATE_STAMP} -JDateTime=${DATE_STAMP} \
    -e -o "${HTML_DIR}"
fi

echo "[INFO] Test completed at $(date)"

# ===========================================================
# [STEP 8] Validate and repair .jtl if needed
# ===========================================================
if ! tail -n 1 "${JTL_FILE}" | grep -q "</testResults>"; then
  echo "[WARN] Incomplete .jtl detected â€” fixing closing tag"
  sed -i '$d' "${JTL_FILE}" || true
  echo "</testResults>" | sudo tee -a "${JTL_FILE}" >/dev/null
  echo "REPAIRED at $(date)" | sudo tee "${STATUS_FILE}" >/dev/null
else
  echo "SUCCESS at $(date)" | sudo tee "${STATUS_FILE}" >/dev/null
fi

# ===========================================================
# [STEP 9] Generate HTML report (no rerun)
# ===========================================================
if ! sudo "${JMETER_BIN}/jmeter" -g "${JTL_FILE}" -o "${HTML_DIR}"; then
  echo "[ERROR] Report generation failed â€” check .jtl format"
  echo "FAILED at $(date)" | sudo tee "${STATUS_FILE}" >/dev/null
fi

# ===========================================================
# [STEP ðŸ”Ÿ] Upload results to S3 with retries
# ===========================================================
echo "[STEP 10] Uploading results to S3..."
for i in {1..3}; do
  if aws s3 cp "${RESULT_DIR}" "s3://${S3_BUCKET}/results/${USECASE_NAME}/${DATE_STAMP}/" --recursive --only-show-errors; then
    echo "[INFO] Upload succeeded on attempt $i"
    break
  else
    echo "[WARN] Upload attempt $i failed, retrying in 10s..."
    sleep 10
  fi
done

# ===========================================================
# [FINAL] Summary and cleanup
# ===========================================================
echo "[INFO] Results available at: s3://${S3_BUCKET}/results/${USECASE_NAME}/${DATE_STAMP}/"
echo "[INFO] Status file: ${STATUS_FILE}"
sudo umount "${EFS_MOUNT}" || true
echo "[INFO] Completed successfully at $(date)"
