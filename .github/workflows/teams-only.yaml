name: Teams Notification Only

on:
  workflow_call:
    inputs:
      DEPLOY_META_JSON:
        description: 'Base64-encoded JSON with deployment metadata (any keys)'
        required: true
        type: string

    secrets:
      TEAMS_WEBHOOK_URL:
        description: 'Teams Incoming Webhook URL'
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Capture timestamps
        run: |
          echo "BUILD_START=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "BUILD_END=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

      - uses: actions/setup-python@v4

      - name: Decode & send Teams card
        env:
          INPUT_DEPLOY_META_JSON: ${{ inputs.DEPLOY_META_JSON }}
          TEAMS_WEBHOOK_URL:     ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          python3 << 'EOF'
          import os, json, base64, requests

          # 1) Decode the payload
          md = json.loads(base64.b64decode(os.environ['INPUT_DEPLOY_META_JSON']))

          # 2) Build facts dynamically
          facts = []
          for k, v in md.items():
              name = k.replace('_',' ').title()
              val  = str(v).upper() if k.lower()=='status' else str(v)
              facts.append({'name': name, 'value': val})

          # 3) Map status to emoji & color
          status = md.get('status','').upper()
          emoji_map = {'SUCCESS':'âœ…','FAILED':'âŒ','CANCELLED':'âš ï¸'}
          color_map = {'SUCCESS':'#00FF00','FAILED':'#FF0000','CANCELLED':'#FFA500'}
          emoji = emoji_map.get(status, 'â„¹ï¸')
          theme = color_map.get(status, '#808080')

          # 4) Build and post the Teams MessageCard
          card = {
            "@type":"MessageCard",
            "@context":"https://schema.org/extensions",
            "themeColor": theme,
            "summary": f"Build {status or 'Notification'}",
            "sections":[
              {"activityTitle":"ðŸ“ Deployment Information",
               "facts": facts,
               "markdown": True}
            ]
          }

          requests.post(
            os.environ['TEAMS_WEBHOOK_URL'],
            json=card,
            headers={'Content-Type':'application/json'}
          ).raise_for_status()
          EOF
