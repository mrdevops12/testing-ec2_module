name: Sync Grafana chart to ECR (flattened path)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Grafana chart version (e.g. 8.6.2)"
        required: true
      chart_name:
        description: "Chart name"
        required: true
        default: grafana

env:
  AWS_REGION: us-east-1
  AWS_ROLE: arn:aws:iam::817786531545:role/iam-role-gh-runner-oidc-access
  REGISTRY: 817786531545.dkr.ecr.us-east-1.amazonaws.com
  SRC_HELM_REPO: https://grafana.github.io/helm-charts
  HELM_EXPERIMENTAL_OCI: "1"

jobs:
  sync:
    runs-on: ${{ vars.BXD_GITHUB_RUNNER }}  # or arc-rs-nonprod
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure flat ECR repo exists (actions/grafana)
        run: |
          aws ecr describe-repositories \
            --repository-names "actions/grafana" \
            --region $AWS_REGION >/dev/null 2>&1 || \
          aws ecr create-repository \
            --repository-name "actions/grafana" \
            --region $AWS_REGION \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256

      - name: Login to ECR (for Helm OCI)
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | helm registry login --username AWS --password-stdin $REGISTRY

      - name: Pull Grafana chart
        run: |
          helm repo add grafana "$SRC_HELM_REPO"
          helm repo update
          helm pull grafana/${{ inputs.chart_name }} --version ${{ inputs.version }}

      - name: Rename chart package to avoid nested repo path
        run: |
          FILE=$(ls ${{ inputs.chart_name }}-*.tgz)
          mv "$FILE" actions-grafana.tgz

      - name: Push chart to ECR (flat path)
        run: |
          helm push actions-grafana.tgz oci://$REGISTRY/actions/grafana
