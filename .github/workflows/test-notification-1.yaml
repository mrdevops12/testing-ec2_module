  prepare-json:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      DEPLOY_META_JSON: ${{ steps.encode.outputs.DEPLOY_META_JSON }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: get-version
        run: |
          if [ -f package.json ]; then
            # manifest-based
            VERSION=$(jq -r .version package.json)
          elif git describe --tags --abbrev=0 >/dev/null 2>&1; then
            # tag-based
            VERSION=$(git describe --tags --abbrev=0)
          else
            # fallback to SHA
            VERSION=${GITHUB_SHA::8}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Encode metadata JSON
        id: encode
        run: |
          JSON=$(jq -n \
            --arg product "Pathway" \
            --arg branch  "${{ inputs.BRANCH }}" \
            --arg version "$VERSION" \
            --arg env     "${{ inputs.ENV }}" \
            --arg status  "${{ needs.build.result }}" \
            --arg build   "${{ github.run_number }}" \
            '{ product: $product, branch: $branch, version: $version, env: $env, status: $status, build: $build }'
          )
          echo "DEPLOY_META_JSON=$( echo "$JSON" | base64 -w0 )" >> $GITHUB_OUTPUT
